<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="canonical" href="https://pakistanaddress.github.io/html/category/article-2376.htm" />
<title>使用Proftpd支持FTP/SFTP权限管控 - Pakistan Address</title>
<!-- for-mobile-apps -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="icon" href="/assets/addons/xcblog/img/pakistanaddress/favicon.ico" type="image/x-icon"/>
<script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false);
		function hideURLbar(){ window.scrollTo(0,1); } </script>
<!-- //for-mobile-apps -->
<link href="/assets/addons/xcblog/css/pakistanaddress/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
<link href="/assets/addons/xcblog/css/pakistanaddress/style.css" rel="stylesheet" type="text/css" media="all" />
<!-- js -->
<script type="text/javascript" src="/assets/addons/xcblog/js/frontend/pakistanaddress/jquery-2.1.4.min.js"></script>
<!-- //js -->
<link href='https://fonts.googleapis.com/css?family=Maven+Pro:400,500,700,900' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700,700italic,800,800italic' rel='stylesheet' type='text/css'>
<!-- start-smoth-scrolling -->
<script type="text/javascript">
	jQuery(document).ready(function($) {
		$(".scroll").click(function(event){		
			event.preventDefault();
			$('html,body').animate({scrollTop:$(this.hash).offset().top},1000);
		});
	});
</script>
<!-- start-smoth-scrolling -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?21f4e50ed805b3a1bd1374e6b345c04a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3332997411212854"
     crossorigin="anonymous"></script>
</head>

<body>
    <!-- header -->
	<div class="header" id="ban">
		<div class="container">
			<div class="w3ls_logo">
								<a href="/">Pakistan Address</a>
							</div>
			<div class="header_right">
			<nav class="navbar navbar-default">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse nav-wil" id="bs-example-navbar-collapse-1">
					<nav class="link-effect-7" id="link-effect-7">
						<ul class="nav navbar-nav">
														<li><a href="/">首页</a></li>
														<li><a href="/html/category/">文章分类</a></li>
														<li><a href="#">关于</a></li>
							<li><a href="#">联系</a></li>
						</ul>
					</nav>
				</div>
				<!-- /.navbar-collapse -->
			</nav>
			</div>
			<div class="clearfix"> </div>
		</div>
	</div>
<!-- //header -->
    <!-- about -->
    <div class="about">
        <div class="container">
            <h1 style="word-break: break-all;">使用Proftpd支持FTP/SFTP权限管控</h1>
            <ul>
                <li><a href="/">首页</a><i>|</i></li>
                <li><a href="/html/category/">文章分类</a><i>|</i></li>
                <li>正文</li>
            </ul>
        </div>
    </div>
    <!-- //about -->
    <!-- single -->
    <div class="single">
        <div class="container">
            <div class="col-md-9">
                <div class="wthree_single_grid1">
                      				  				  				<h1 id="简介">简介</h1> <h2 id="ftp">FTP</h2> <p>文件传输协议，FTP由FTP服务器（存储文件）和FTP客户端（通过FTP协议访问FTP服务器上的资源）组成</p> <h3 id="传输方式">传输方式</h3> <ol> <li><strong>主动模式（Port）</strong> <ol> <li>客户端与服务器端的TCP 21端口建立连接 -> 登录</li> <li>发送PORT命令告知服务器需要做什么操作，客户端使用哪个端口传输数据</li> <li>服务器端通过TCP 20端口连接至客户端指定端口</li> <li>进行数据传输</li> </ol> </li> <li><strong>被动模式（Passive）</strong> <ol> <li>客户端与服务器端的TCP 21端口建立连接 -> 登录</li> <li>客户端发送Pasv命令到服务器端</li> <li>服务器端收到Pasv命令后随机打开一个端口，并通知客户端在此端口传输数据</li> <li>进行数据传输</li> </ol> </li> </ol> <ul> <li>主动模式：将服务器21、20端口打开后仍然有问题，可能是客户端防火墙拦截</li> <li>被动模式：服务器端的数据传输端口是随机打开的，可能会被防火墙拦截</li> </ul> <ol start="3"> <li><strong>proftpd配置</strong></li> </ol> <pre><code class="language-bash"># 禁止主动模式访问 <Limit PORT>   DenyAll </Limit>  # 禁止被动模式访问 <Limit PASV>   DenyAll </Limit></code></pre> <h2 id="sftp">SFTP</h2> <p>安全文件传输协议，基于 SSH2 协议建立安全连接来传输文件。与FTP不同，SFTP不区分数据通道与命令通道，而是数据和命令都会通过单个连接以特殊格式的数据包进行传输，配置时可以指定端口。可以通过用户名密码认证、RSA认证、DSA认证等方式管理用户登录</p> <h1 id="配置工具">配置工具</h1> <ol> <li>大多数Linux系统自带的openssh除了提供ssh连接外还提供sftp功能，使用方便、配置简单，但是无法做到像samba那样细粒度的权限管控，只能对不同的用户配置不同的家目录以及文件夹权限</li> <li>proftpd可高度配置权限管控，设置用户和组，同时支持FTP与SFTP的使用，但是配置相对繁琐很多</li> </ol> <p>下面介绍proftpd的配置使用</p> <h1 id="proftpd使用">proftpd使用</h1> <h2 id="ftp基本配置">FTP基本配置</h2> <p>使用ftpasswd工具创建用户和组</p> <ol> <li>添加用户和组</li> </ol> <pre><code class="language-bash"># 创建galen用户，并设置家目录为/vol/galen ftpasswd --passwd --file=/etc/ftpd/ftpd.passwd --name=galen --uid=1001 \ --home=/vol/galen --shell=/bin/bash # 创建user1 ftpasswd --passwd --file=/etc/ftpd/ftpd.passwd --name=user1 --uid=1002 \ --home=/vol/user1 --shell=/bin/bash  # 添加用户组group1，添加galen和user1作为组成员 ftpasswd --group --file=/etc/ftpd/ftpd.group --name=group1 --gid=2001 \ --member=galen,user1</code></pre> <ol start="2"> <li>写入相关配置到/etc/proftpd/proftpd.conf</li> </ol> <pre><code class="language-bash"># 设置FTP用户登录根目录为/vol DefaultRoot /vol # 设置用户和组文件路径 AuthUserFile /etc/ftpd/ftpd.passwd AuthGroupFile /etc/proftpd/ftpd.group # 资源控制，对处理FTP session的子进程限制内存 <IfModule mod_rlimit.c>   RLimitMemory session 4G </IfModule></code></pre> <h2 id="启用sftp">启用SFTP</h2> <p>使用VirtualHost配置一个独立的SFTP服务器，该配置快的作用是在同一个物理机上虚拟出多个FTP服务器。具体示例如下：</p> <pre><code class="language-bash"><IfModule mod_sftp.c>     <VirtualHost 0.0.0.0>         ServerName "SFTP Server"         DefaultRoot /vol         SFTPEngine on         # SFTP使用的端口配置为2222         Port 2222         SFTPLog /var/log/proftpd/sftp.log         AllowOverwrite yes         # SFTPHostKey需要提供rsa、dsa以及可选的ECDSA key         # 注意：这些文件需要与SSH2使用的key文件完全相同，所以直接加入ssh的key文件路径         SFTPHostKey /etc/ssh/ssh_host_rsa_key         SFTPHostKey /etc/ssh/ssh_host_dsa_key         # 使用用户名密码的认证方式         SFTPAuthMethods password         # 同以上FTP设置的用户一样         AuthUserFile /etc/proftpd/ftpd.passwd         AuthGroupFile /etc/proftpd/ftpd.group         MaxLoginAttempts 6         SFTPCompression delayed     </VirtualHost> </IfModule></code></pre> <p>以上可以做到用户和组同时通过SFTP与FTP访问服务器，下面简单配置登录限制与权限管控</p> <h2 id="权限管控">权限管控</h2> <p>proftpd的<limit> 提供了强大权限控制功能，通过向该块添加不同的FTP原生指令（指令列表），配合AllowUser、AllowGroup、AllowAll、DenyAll可以实现非常细粒度的权限控制</limit></p> <h3 id="limit">Limit</h3> <p>Proftpd将以上FTP原生指令组合成为指令组:</p> <ul> <li>ALL<br /><em>Covering</em>: all FTP commands (but<strong>not</strong> LOGIN)</li> <li>DIRS<br /><em>Covering</em>: CDUP, CWD, LIST, MDTM, MLSD, MLST, NLST, PWD, RNFR, STAT, XCUP, XCWD, XPWD</li> <li>LOGIN<br /><em>Covering</em>: client logins</li> <li>READ<br /><em>Covering</em>: RETR, SIZE</li> <li>WRITE<br /><em>Covering</em>: APPE, DELE, MKD, RMD, RNTO, STOR, STOU, XMKD, XRMD</li> </ul> <p>如果指令组和原生指令同时添加到配置，那么原生指令的优先级最高 -> 次优先的是命令组 -> 其他命令组优先级大于带ALL关键字</p> <h3 id="umask">Umask</h3> <p>linux权限参考如下</p> <table> <thead> <tr> <th><strong>Mode</strong></th> <th><strong>Label</strong></th> <th><strong>Description</strong></th> </tr> </thead> <tbody> <tr> <td>0777</td> <td>rwxrwxrwx</td> <td>read/write/execute permissions for user owner, group owner, and other</td> </tr> <tr> <td>0666</td> <td>rw-rw-rw-</td> <td>read/write permissions for user owner, group owner, and other</td> </tr> <tr> <td>0755</td> <td>rwxr-xr-x</td> <td>read/write/execute permissions for user owner, read/execute permissions for group owner and other</td> </tr> <tr> <td>0750</td> <td>rwxr-x---</td> <td>read/write/execute permissions for user owner, read permission for group owner, no permissions for other</td> </tr> <tr> <td>0644</td> <td>rw-r--r--</td> <td>read/write permissions for user owner, read permission for group owner and other</td> </tr> <tr> <td>0511</td> <td>r-x--x--x</td> <td>read/execute permissions for user owner, execute permission for group owner and other</td> </tr> </tbody> </table> <ol> <li>对于新建文件或目录的权限控制使用umask，即：新文件或目录的权限 = 基本权限与umask按位异或，举例：</li> </ol> <p>基本权限为777，如果我们想将创建的文件设置为创建用户可读写执行，同组用户与其他用户只读，那么设置umask为022，最终得到新建文件或目录的权限为755</p> <pre><code class="language-python">7 ^ 0 = 7 7 ^ 2 = 5 7 ^ 2 = 5</code></pre> <ol start="2"> <li>proftpd的基本权限没有执行位，及base-mode  = 666</li> <li>我们想设置ftp目录 /vol/share1 为创建者可读写、同组只读、其他用户只读，第一个022为新建文件的umask，第二个022为新建目录的umask</li> </ol> <pre><code class="language-bash"><Directory "/vol/share1">   Umask 022 022   <Limit DIRS WRITE>   AllowAll   </Limit> </Directory></code></pre> <h2 id="详细示例">详细示例</h2> <p>该配置实现了：</p> <ul> <li>用户、组的配置</li> <li>某个目录允许某个组或用户读写</li> <li>用户、组、其他用户对文件的使用权限</li> <li>通过配置目录禁止访问变相实现FTP、SFTP可以一同使用，或者单独使用某一个</li> </ul> <ol> <li>user</li> </ol> <pre><code class="language-bash"># /etc/proftpd/ftpd.passwd # 将家目录设为不存在的目录，后续使用<Limit>进行统一控制 u1:$1$uWROkZWh$FzA2bjAqX8WXSyahNuhLV0:2000:2000::/nonexistent:/bin/bash galen:$1$vzCnaVih$cbSGH3balmW7K44PILuCB/:2001:2003::/nonexistent:/bin/bash otheruser:$1$3QmQ7wF3$qRJE9nC8t8w4n7qtyshE1/:2004:2004::/nonexistent:/bin/bash user1:$1$XMQbJG3S$4BUxe9VbBCWrItfE2AjuH0:2002:2003::/nonexistent:/bin/bash</code></pre> <ol start="2"> <li>group</li> </ol> <pre><code class="language-bash"># /etc/proftpd/ftpd.group samba_group_group1:x:2003:galen,user1</code></pre> <ol start="3"> <li>proftpd.conf</li> </ol> <pre><code class="language-bash">Include /etc/proftpd/conf.d/ DefaultRoot /vol AllowForeignAddress OFF AuthUserFile /etc/proftpd/ftpd.passwd AuthGroupFile /etc/proftpd/ftpd.group  <IfModule mod_rlimit.c>   RLimitMemory session 4G </IfModule> # 禁止所有人操作根目录 <Directory "/vol">   <Limit WRITE>     DenyAll   </Limit> </Directory> # 允许操作根目录的子目录 <Directory "/vol/*/*">   <Limit ALL>     AllowAll   </Limit> </Directory> # /vol/share1目录允许属于samba_group_group1组的用户读写 <Directory "/vol/share1">   Umask 022 022   <Limit DIRS WRITE>     AllowGroup samba_group_group1     AllowUser None     DenyAll   </Limit> </Directory> # /vol/share3禁止所有ftp登录的用户使用 <Directory "/vol/share3">   Umask 777 777   <Limit DIRS WRITE READ>     AllowGroup None     AllowUser None     DenyAll   </Limit> </Directory> # /vol/share2目录允许otheruser使用，创建的文件与目录权限为666（proftpd没有执行位） <Directory "/vol/share2">   Umask 000 000   <Limit DIRS WRITE>     AllowGroup None     AllowUser otheruser     DenyAll   </Limit> </Directory> # 以上为使用FTP登录的设置 # 以下为使用SFTP登录的设置 <IfModule mod_sftp.c>     <VirtualHost 0.0.0.0>         ServerName "SFTP Server"         DefaultRoot /vol         SFTPEngine on         Port 2222         SFTPLog /var/log/proftpd/sftp.log         AllowOverwrite yes         SFTPHostKey /etc/ssh/ssh_host_rsa_key         SFTPHostKey /etc/ssh/ssh_host_dsa_key         SFTPAuthMethods password         AuthUserFile /etc/proftpd/ftpd.passwd         AuthGroupFile /etc/proftpd/ftpd.group         MaxLoginAttempts 6         SFTPCompression delayed          <Directory "/vol">           <Limit WRITE>             DenyAll           </Limit>         </Directory>          <Directory "/vol/*/*">           <Limit ALL>             AllowAll           </Limit>         </Directory>          <Directory "/vol/share1">           Umask 022 022           <Limit DIRS WRITE>             AllowGroup samba_group_group1             AllowUser None             DenyAll           </Limit>         </Directory>         # 使用SFTP登录的任何用户都可以操作/vol/share3         <Directory "/vol/share3">           Umask 000 000           <Limit DIRS WRITE>             AllowGroup samba_group_group1             AllowUser otheruser             DenyAll           </Limit>         </Directory>         # 不允许使用SFTP登录的用户操作/vol/share2         <Directory "/vol/share2">           Umask 777 777           <Limit DIRS WRITE READ>             AllowGroup None             AllowUser None             DenyAll           </Limit>         </Directory>     </VirtualHost> </IfModule></code></pre> <h1 id="总结">总结</h1> <p>proftpd实现的feature还有很多，比如：匿名用户、匿名FTP服务器、隐藏目录或文件、过期帐号等设置，有需要可以研究官网</p> 			                </div>
                <div class="col-md-12 mt-5">
                                        <p>上一个：<a href="/html/category/article-2375.htm">Source Generator实战</a></p>
                                        <p>下一个：<a href="/html/category/article-2377.htm">远程调用RestTemplate</a></p>
                                    </div>
                            </div>
            <div class="col-md-3">
                <div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">热门文章</h3>
    </div>
    <div class="panel-body">
        <ul class="p-0 x-0" style="list-style: none;margin: 0;padding: 0;">
                        <li class="py-2"><a href="/html/category/article-6998.htm" title="天宠宠物殡葬官网上海（天宠宠物殡葬人均消费）">天宠宠物殡葬官网上海（天宠宠物殡葬人均消费）</a></li>
                        <li class="py-2"><a href="/html/category/article-7781.htm" title="包含领养宠物网页平台的词条">包含领养宠物网页平台的词条</a></li>
                        <li class="py-2"><a href="/html/category/article-7505.htm" title="鸡蛋汤如何打">鸡蛋汤如何打</a></li>
                        <li class="py-2"><a href="/html/category/article-7458.htm" title="开宠物店靠什么赚钱（开宠物店挣钱么）">开宠物店靠什么赚钱（开宠物店挣钱么）</a></li>
                        <li class="py-2"><a href="/html/category/article-7275.htm" title="动物打防疫针管用吗（动物打预防针的作用）">动物打防疫针管用吗（动物打预防针的作用）</a></li>
                        <li class="py-2"><a href="/html/category/article-7413.htm" title="延吉宠物店电话 延吉宠物店电话号码">延吉宠物店电话 延吉宠物店电话号码</a></li>
                        <li class="py-2"><a href="/html/category/article-7321.htm" title="哈尔滨农大兽医院电话号码是多少（中国农业哈尔滨兽医研究所）">哈尔滨农大兽医院电话号码是多少（中国农业哈尔滨兽医研究所）</a></li>
                        <li class="py-2"><a href="/html/category/article-6676.htm" title="车险哪个品牌好(车险哪个品牌好一些)">车险哪个品牌好(车险哪个品牌好一些)</a></li>
                        <li class="py-2"><a href="/html/category/article-6631.htm" title="开个小型宠物食品加工厂需要多少钱 开个小型宠物食品加工厂需要多少钱呢">开个小型宠物食品加工厂需要多少钱 开个小型宠物食品加工厂需要多少钱呢</a></li>
                        <li class="py-2"><a href="/html/category/article-7183.htm" title="2020年开宠物店怎么样（2020年开宠物店怎么样了）">2020年开宠物店怎么样（2020年开宠物店怎么样了）</a></li>
                    </ul>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">归纳</h3>
    </div>
    <div class="panel-body">
        <ul class="p-0 x-0" style="list-style: none;margin: 0;padding: 0;">
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">30</span> <a href="/html/date/2024-08/" title="2024-08 归档">2024-08</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">62</span> <a href="/html/date/2024-07/" title="2024-07 归档">2024-07</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">60</span> <a href="/html/date/2024-06/" title="2024-06 归档">2024-06</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">62</span> <a href="/html/date/2024-05/" title="2024-05 归档">2024-05</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">60</span> <a href="/html/date/2024-04/" title="2024-04 归档">2024-04</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">62</span> <a href="/html/date/2024-03/" title="2024-03 归档">2024-03</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">44</span> <a href="/html/date/2024-02/" title="2024-02 归档">2024-02</a></h4>
            </li>
                    </ul>
    </div>
</div>

            </div>
        </div>
    </div>
    <!-- //single -->
    <!-- footer -->
	
	<div class="copy-right-social">
		<div class="container">
			<div class="footer-pos">
				<a href="#ban" class="scroll"><img src="/assets/addons/xcblog/img/pakistanaddress/arrow.png" alt=" " class="img-responsive" /></a>
			</div>
            <div class="col-lg-8 footer-left">
                <p class="m-0">Pakistan Address 版权所有</p>
            </div>
			<div class="copy-right-social1">
				<div class="w3l_social_icons w3l_social_icons1">
					<ul>
						<li><a href="#" class="facebook"></a></li>
						<li><a href="#" class="twitter"></a></li>
						<li><a href="#" class="google_plus"></a></li>
						<li><a href="#" class="pinterest"></a></li>
						<li><a href="#" class="instagram"></a></li>
					</ul>
				</div>
			</div>
			<div class="clearfix"> </div>
		</div>
	</div>
<!-- //footer -->
<!-- for bootstrap working -->
	<script src="/assets/addons/xcblog/js/frontend/pakistanaddress/bootstrap.js"></script>
    <script>
    $(function() {
        $('.js_to').click(function() {
            var url = $(this).data('url');
            var code = $(this).data('code');
            url += code;

            window.open(url);
        })
    });
    </script>
</body>

</html>